trigger:
  branches:
    include:
      - main
pool:
  name: Default  # Tu agente autoservido local
variables:
  dockerImage: ic0110/infosyp-prueba
  dockerTag: latest
  dockerfilePath: docker/app/Dockerfile
  buildContext: .
  k8sYamlPath: environment/
  sonarProjectKey: dotnet-album-viewer
  sonarProjectName: AlbumViewer
  sonarHostUrl: 'http://localhost:9000'
  sonarToken: '$(SONARQUBE_TOKEN)'  # Aseg√∫rate de configurarlo como variable secreta
stages:
# ========================
# 1. SONARQUBE ANALYSIS
# ========================
- stage: SonarQube
  displayName: "SonarQube Analysis"
  jobs:
    - job: Analysis
      displayName: "Run SonarQube analysis"
      steps:
        - checkout: self
        - task: SonarQubePrepare@5
          displayName: "Prepare SonarQube"
          inputs:
            SonarQube: 'Local Agent SonarQube'
            scannerMode: 'MSBuild'
            projectKey: $(sonarProjectKey)
            projectName: $(sonarProjectName)
        - script: |
            dotnet restore src/AlbumViewerNetCore/AlbumViewerNetCore.csproj
            dotnet build src/AlbumViewerNetCore/AlbumViewerNetCore.csproj --no-restore
          displayName: "Restore & Build"
        - task: SonarQubeAnalyze@5
          displayName: "Run SonarQube Analysis"
        - task: SonarQubePublish@5
          displayName: "Publish SonarQube Results"
          inputs:
            pollingTimeoutSec: '300'
# ========================
# 2. BUILD & PUSH
# ========================
- stage: Docker
  dependsOn: SonarQube
  condition: succeeded()
  displayName: "Docker Build & Push"
  jobs:
    - job: BuildPush
      steps:
        - task: Docker@2
          displayName: "Build Docker Image"
          inputs:
            command: build
            Dockerfile: $(dockerfilePath)
            tags: $(dockerTag)
            repository: $(dockerImage)
            buildContext: $(buildContext)
        - task: Docker@2
          displayName: "Push to DockerHub"
          inputs:
            command: push
            tags: $(dockerTag)
            repository: $(dockerImage)
# ========================
# 3. DEPLOY DATABASE FIRST
# ========================
- stage: DeployDatabase
  dependsOn: Docker
  displayName: "Deploy Database"
  jobs:
    - job: DeployDB
      steps:
        - script: |
            echo "Deploying database components..."
            kubectl apply -f $(k8sYamlPath)mysql-deployment.yaml
          displayName: "Deploy Database"
       
        - script: |
            echo "Waiting for DB pod to be ready..."
            kubectl wait --for=condition=ready pod -l app=album-db --timeout=300s
          displayName: "Wait for DB readiness"
       
        - script: |
            echo "Verifying database connection..."
            kubectl exec -l app=album-db -- mysql -u root -proot -e "SHOW DATABASES;"
          displayName: "Verify DB Connection"
       
        - powershell: |
            $POD_NAME = kubectl get pods -l app=album-db -o jsonpath="{.items[0].metadata.name}"
            Write-Host "Pod name: $POD_NAME"
            Write-Host "Loading SQL data..."
            Get-Content AlbumViewerSqlServerData.sql | kubectl exec -i $POD_NAME -- mysql -u root -proot AlbumViewer
            Write-Host "Verifying data load..."
            kubectl exec $POD_NAME -- mysql -u root -proot AlbumViewer -e "SELECT COUNT(*) as TableCount FROM information_schema.tables WHERE table_schema = 'AlbumViewer';"
          displayName: "Load and Verify SQL Data"
       
        - script: |
            echo "Database deployment completed successfully"
            kubectl get pods -l app=album-db -o wide
          displayName: "Database Status"

# ========================
# 4. DEPLOY APPLICATION
# ========================
- stage: DeployApp
  dependsOn: DeployDatabase
  condition: succeeded()
  displayName: "Deploy Application"
  jobs:
    - job: DeployApplication
      steps:
        - script: |
            echo "Deploying application and ingress components..."
            kubectl apply -f $(k8sYamlPath)app-deployment.yaml
            kubectl apply -f $(k8sYamlPath)ingress.yaml
          displayName: "Deploy Application"
       
        - script: |
            echo "Waiting for application to be ready..."
            kubectl wait --for=condition=ready pod -l app=album-viewer --timeout=300s
          displayName: "Wait for App readiness"
       
        - script: |
            echo "Testing application connectivity to database..."
            kubectl exec -l app=album-viewer -- curl -f http://localhost/health || echo "Health check endpoint not available"
          displayName: "Test App-DB Connection"
       
        - script: |
            echo "Deployment completed successfully"
            kubectl get pods -o wide
            kubectl get services
            echo "Application should now be accessible"
          displayName: "Final Status"